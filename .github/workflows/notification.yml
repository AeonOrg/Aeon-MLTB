name: Telegram Notification

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          DEFAULT_CHAT_ID: "-1001964570396"
          MAIN_CHAT_ID: "-1001980878451"
          TELEGRAM_BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH_NAME: ${{ github.ref_name }}
          USER: ${{ github.actor }}
          AUTHOR_URL: https://github.com/${{ github.actor }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          if [[ "$REPO" != "AeonOrg/Aeon-MLTB" ]]; then
            echo "Repository is not the original. Skipping Telegram notification."
            exit 0
          fi

          CHAT_ID=$DEFAULT_CHAT_ID
          if [[ "$BRANCH_NAME" == "main" ]]; then
            CHAT_ID=$MAIN_CHAT_ID
          fi

          REPO_URL="https://github.com/${REPO}"
          BRANCH_URL="${REPO_URL}/commits/${BRANCH_NAME}"

          # Function to escape HTML special characters
          escape_html() {
            echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&#39;/g'
          }

          MESSAGE="<b>New Commit Pushed</b>\n\n"
          ESCAPED_USER=$(escape_html "$USER")
          ESCAPED_REPO=$(escape_html "$REPO")
          ESCAPED_BRANCH=$(escape_html "$BRANCH_NAME")
          MESSAGE+="<b>Commit by:</b> <a href=\"${AUTHOR_URL}\">${ESCAPED_USER}</a>\n"
          MESSAGE+="<b>Repository:</b> <a href=\"${REPO_URL}\">${ESCAPED_REPO}</a>\n"
          MESSAGE+="<b>Branch:</b> <a href=\"${BRANCH_URL}\">${ESCAPED_BRANCH}</a>\n\n"

          mapfile -t COMMITS < <(echo "$COMMITS_JSON" | jq -c '.[]')
          for commit in "${COMMITS[@]}"; do
            HASH=$(jq -r '.id' <<< "$commit")
            FULL_MSG=$(jq -r '.message' <<< "$commit")
            MSG_TITLE=$(echo "$FULL_MSG" | head -n 1)
            MSG_BODY=$(echo "$FULL_MSG" | tail -n +2)
            SHORT_HASH=${HASH:0:7}
            COMMIT_URL="${REPO_URL}/commit/${HASH}"
            
            # Escape HTML special characters in commit message
            ESCAPED_TITLE=$(escape_html "$MSG_TITLE")
            MESSAGE+="<a href=\"${COMMIT_URL}\">${SHORT_HASH}</a>: ${ESCAPED_TITLE}\n"
            
            if [[ -n "$MSG_BODY" ]]; then
              ESCAPED_BODY=$(escape_html "$MSG_BODY")
              MESSAGE+="${ESCAPED_BODY}\n"
            fi
          done

          # Create JSON payload with proper escaping
          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "$CHAT_ID" \
            --arg text "$MESSAGE" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "HTML",
              disable_web_page_preview: true
            }')

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"